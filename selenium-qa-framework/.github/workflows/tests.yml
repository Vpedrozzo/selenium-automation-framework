name: ğŸ§ª Selenium Tests

on:
  push:
    branches: [ main, develop ]   
  pull_request:
    branches: [ main ]          
  schedule:
    - cron: '0 9 * * 1'        

# ConfiguraÃ§Ãµes globais
env:
  PYTHONPATH: ${{ github.workspace }}

jobs:
  
  # Job 1: Testes bÃ¡sicos e rÃ¡pidos
  quick-tests:
    name: ğŸš€ Testes RÃ¡pidos
    runs-on: ubuntu-latest
    
    steps:
    # 1. Baixar o cÃ³digo do repositÃ³rio
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
    
    # 2. Configurar Python
    - name: ğŸ Configurar Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    # 3. Cache de dependÃªncias (acelera execuÃ§Ã£o)
    - name: ğŸ“¦ Cache das dependÃªncias
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    # 4. Instalar dependÃªncias
    - name: ğŸ”§ Instalar dependÃªncias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # 5. Executar testes bÃ¡sicos
    - name: ğŸ§ª Executar testes bÃ¡sicos
      run: |
        pytest tests/test_primeiro_exemplo_CORRIGIDO.py::test_site_confiavel_para_testes \
               --headless \
               -v \
               --tb=short \
               --junit-xml=reports/junit-quick.xml
    
    # 6. Upload dos resultados
    - name: ğŸ“Š Upload resultados bÃ¡sicos
      uses: actions/upload-artifact@v3
      if: always()  # Sempre faz upload, mesmo se teste falhar
      with:
        name: quick-test-results
        path: |
          reports/
          screenshots/
        retention-days: 30

  # Job 2: Testes completos com mÃºltiplos browsers
  full-tests:
    name: ğŸŒ Testes Completos - ${{ matrix.browser }}
    runs-on: ubuntu-latest
    needs: quick-tests  # SÃ³ roda se testes bÃ¡sicos passarem
    
    strategy:
      fail-fast: false  # Continua testando outros browsers mesmo se um falhar
      matrix:
        browser: ['chrome', 'firefox']
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    # Configurar browsers
    - name: ğŸŒ Configurar Chrome
      if: matrix.browser == 'chrome'
      uses: browser-actions/setup-chrome@latest
      with:
        chrome-version: stable
    
    - name: ğŸ¦Š Configurar Firefox
      if: matrix.browser == 'firefox'
      uses: browser-actions/setup-firefox@latest
      with:
        firefox-version: latest
    
    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # Executar suite completa de testes
    - name: ğŸ§ª Executar testes data-driven
      run: |
        pytest tests/test_data_driven.py \
               --browser=${{ matrix.browser }} \
               --headless \
               -v \
               --html=reports/report-${{ matrix.browser }}.html \
               --self-contained-html \
               --junit-xml=reports/junit-${{ matrix.browser }}.xml
    
    - name: ğŸ“Š Upload relatÃ³rios por browser
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-${{ matrix.browser }}
        path: |
          reports/
          screenshots/

  # Job 3: Testes de demonstraÃ§Ã£o (para recrutadores)
  demo-tests:
    name: ğŸ¯ Testes de DemonstraÃ§Ã£o
    runs-on: ubuntu-latest
    needs: quick-tests
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸŒ Configurar Chrome
      uses: browser-actions/setup-chrome@latest
    
    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸª Executar testes de demonstraÃ§Ã£o
      run: |
        pytest tests/test_demonstracao_recrutador.py::TestDemonstracaoParaRecrutador::test_sites_populares_para_demo \
               --headless \
               -v \
               -s \
               --html=reports/demo-report.html \
               --self-contained-html
    
    - name: ğŸ“Š Upload relatÃ³rio de demonstraÃ§Ã£o
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: demo-results
        path: reports/demo-report.html

  # Job 4: RelatÃ³rio final consolidado
  final-report:
    name: ğŸ“‹ RelatÃ³rio Consolidado
    runs-on: ubuntu-latest
    needs: [quick-tests, full-tests, demo-tests]
    if: always()  # Roda mesmo se alguns testes falharem
    
    steps:
    - name: ğŸ“¥ Baixar todos os artifacts
      uses: actions/download-artifact@v3
    
    - name: ğŸ“Š Gerar resumo dos testes
      run: |
        echo "# ğŸ“Š Resumo da ExecuÃ§Ã£o dos Testes" > test-summary.md
        echo "" >> test-summary.md
        echo "## ğŸ¯ Testes Executados:" >> test-summary.md
        echo "- âœ… Testes BÃ¡sicos" >> test-summary.md
        echo "- ğŸŒ Testes Chrome/Firefox" >> test-summary.md
        echo "- ğŸª Testes de DemonstraÃ§Ã£o" >> test-summary.md
        echo "" >> test-summary.md
        echo "## ğŸ“ Artefatos Gerados:" >> test-summary.md
        ls -la
        echo "" >> test-summary.md
        echo "**Data:** $(date)" >> test-summary.md
        echo "**Commit:** ${{ github.sha }}" >> test-summary.md
    
    - name: ğŸ“¤ Upload resumo final
      uses: actions/upload-artifact@v3
      with:
        name: final-test-summary
        path: test-summary.md
